// Stealth address types (ERC-5564/6538)

export interface StealthKeyPair {
  spendingPrivateKey: string;
  spendingPublicKey: string;
  viewingPrivateKey: string;
  viewingPublicKey: string;
}

export interface StealthMetaAddress {
  prefix: string;
  spendingPublicKey: string;
  viewingPublicKey: string;
  raw: string;
}

export interface GeneratedStealthAddress {
  stealthAddress: string;         // CREATE2 wallet address (payment destination)
  stealthEOAAddress: string;      // EOA address (the "owner", for signing)
  ephemeralPublicKey: string;
  viewTag: string;
  stealthPublicKey: string;
}

export interface StealthAnnouncement {
  schemeId: number;
  stealthAddress: string;
  ephemeralPublicKey: string;
  viewTag: string;
  metadata: string;
  linkSlug?: string;
  caller: string;
  blockNumber: number;
  txHash: string;
}

export interface ScanResult {
  announcement: StealthAnnouncement;
  stealthPrivateKey: string;
  isMatch: boolean;
  privateKeyVerified?: boolean;
  derivedAddress?: string;
  walletType?: 'eoa' | 'create2';
}

export const SCHEME_ID = { SECP256K1: 1 } as const;

export interface StealthContractAddresses {
  announcer: string;
  registry: string;
}

function getEnv(key: string): string | undefined {
  if (typeof window !== 'undefined') {
    return (window as unknown as { __ENV?: Record<string, string> }).__ENV?.[key]
      || process.env[key];
  }
  return process.env[key];
}

function getContractAddresses(): StealthContractAddresses {
  const announcer = getEnv('NEXT_PUBLIC_STEALTH_ANNOUNCER_ADDRESS');
  const registry = getEnv('NEXT_PUBLIC_STEALTH_REGISTRY_ADDRESS');

  if (announcer && registry) return { announcer, registry };

  // Thanos Sepolia defaults (redeployed 2026-02-07)
  return {
    announcer: '0x2C2a59E9e71F2D1A8A2D447E73813B9F89CBb125',
    registry: '0x9C527Cc8CB3F7C73346EFd48179e564358847296',
  };
}

export const CANONICAL_ADDRESSES = getContractAddresses();

// Block number when contracts were deployed â€” scanner should never start after this
export const DEPLOYMENT_BLOCK = 6272527;

// CREATE2 Stealth Wallet Factory (Thanos Sepolia)
export const STEALTH_WALLET_FACTORY = '0x85e7Fe33F594AC819213e63EEEc928Cb53A166Cd';
export const STEALTH_WALLET_CREATION_CODE = '0x60a060405234801561000f575f80fd5b506040516107e03803806107e083398101604081905261002e9161003f565b6001600160a01b031660805261006c565b5f6020828403121561004f575f80fd5b81516001600160a01b0381168114610065575f80fd5b9392505050565b60805161074f6100915f395f8181607e015281816101a90152610365015261074f5ff3fe608060405260043610610041575f3560e01c80635cd5972c1461004c5780638da5cb5b1461006d578063affed0e0146100bd578063da0980c7146100df575f80fd5b3661004857005b5f80fd5b348015610057575f80fd5b5061006b610066366004610599565b6100fe565b005b348015610078575f80fd5b506100a07f000000000000000000000000000000000000000000000000000000000000000081565b6040516001600160a01b0390911681526020015b60405180910390f35b3480156100c8575f80fd5b506100d15f5481565b6040519081526020016100b4565b3480156100ea575f80fd5b5061006b6100f93660046105e8565b61028f565b5f80546040516bffffffffffffffffffffffff1930606090811b8216602084015287901b16603482015260488101919091524660688201526088016040516020818303038152906040528051906020012090505f8160405160200161018f91907f19457468657265756d205369676e6564204d6573736167653a0a3332000000008152601c810191909152603c0190565b6040516020818303038152906040528051906020012090507f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03166101dc828686610459565b6001600160a01b031614610202576040516282b42960e81b815260040160405180910390fd5b5f8054908061021083610680565b909155505060405147905f906001600160a01b0388169083908381818185875af1925050503d805f811461025f576040519150601f19603f3d011682016040523d82523d5f602084013e610264565b606091505b5050905080610286576040516312171d8360e31b815260040160405180910390fd5b50505050505050565b5f30878787876040516102a3929190610698565b6040519081900381205f546bffffffffffffffffffffffff19606096871b811660208501529490951b90931660348201526048810191909152606881019190915260888101919091524660a882015260c8016040516020818303038152906040528051906020012090505f8160405160200161034b91907f19457468657265756d205369676e6564204d6573736167653a0a3332000000008152601c810191909152603c0190565b6040516020818303038152906040528051906020012090507f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316610398828686610459565b6001600160a01b0316146103be576040516282b42960e81b815260040160405180910390fd5b5f805490806103cc83610680565b91905055505f886001600160a01b03168888886040516103ed929190610698565b5f6040518083038185875af1925050503d805f8114610427576040519150601f19603f3d011682016040523d82523d5f602084013e61042c565b606091505b505090508061044e576040516312171d8360e31b815260040160405180910390fd5b505050505050505050565b5f6041821461046957505f610532565b5f61047760208285876106a7565b610480916106ce565b90505f6104916040602086886106a7565b61049a916106ce565b90505f858560408181106104b0576104b06106ec565b919091013560f81c915050601b8110156104d2576104cf601b82610700565b90505b604080515f81526020810180835289905260ff831691810191909152606081018490526080810183905260019060a0016020604051602081039080840390855afa158015610522573d5f803e3d5ffd5b5050506020604051035193505050505b9392505050565b80356001600160a01b038116811461054f575f80fd5b919050565b5f8083601f840112610564575f80fd5b50813567ffffffffffffffff81111561057b575f80fd5b602083019150836020828501011115610592575f80fd5b9250929050565b5f805f604084860312156105ab575f80fd5b6105b484610539565b9250602084013567ffffffffffffffff8111156105cf575f80fd5b6105db86828701610554565b9497909650939450505050565b5f805f805f80608087890312156105fd575f80fd5b61060687610539565b955060208701359450604087013567ffffffffffffffff80821115610629575f80fd5b6106358a838b01610554565b9096509450606089013591508082111561064d575f80fd5b5061065a89828a01610554565b979a9699509497509295939492505050565b634e487b7160e01b5f52601160045260245ffd5b5f600182016106915761069161066c565b5060010190565b818382375f9101908152919050565b5f80858511156106b5575f80fd5b838611156106c1575f80fd5b5050820193919092039150565b803560208310156106e6575f19602084900360031b1b165b92915050565b634e487b7160e01b5f52603260045260245ffd5b60ff81811683821601908111156106e6576106e661066c56fea2646970667358221220befef0ffbba9994d696b7cbf8606cc6dda0e5a488ebe379619b08c1a4531e38b64736f6c63430008140033';

export const STEALTH_WALLET_FACTORY_ABI = [
  'function computeAddress(address _owner) view returns (address)',
  'function deploy(address _owner) returns (address wallet)',
  'function deployAndDrain(address _owner, address _to, bytes _sig)',
];
